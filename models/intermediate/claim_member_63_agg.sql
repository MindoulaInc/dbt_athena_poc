{{
  config(
    materialized = 'table',
    table_type = 'iceberg'
    )
}}

select
  mem.memb_life_id,
  mem.old_memb_life_id,
  mem.reltp_cd,
  mem.relt_desc,
  mem.gndr_cd,
  mem.date_of_birth,
  mem.age,
  mem.lvl_of_cov_cd,
  mem.memb_enrlt_from_dt,
  mem.memb_enrlt_thru_dt,
  mem.addr_line_1,
  mem.addr_line_2,
  mem.city,
  mem.state,
  mem.zip,
  mem.empr_grp_nm,
  mem.renwl_mth,
  mem.seg_id,
  mem.prodt_nm_desc,
  mem.prodt_line_desc,
  mem.pkg_cl_cd,
  mem.empr_grp_id,
  mem.grp_sect,
  mem.dept_nbr,
  mem.rsk_cd,
  mem.hsa_indc,
  mm.supplier_file_log_id,
  mm.rec_num,
  mm.memb_life_id_skey,
  mm.group_number,
  mm.group_section_number,
  mm.department_code_number,
  mm.package_code_nasco_class_code_facets,
  mm.subgroup,
  mm.relationship_code,
  mm.relationship_description,
  mm.level_of_coverage_description,
  mm.claim_type_code,
  mm.claim_number,
  mm.line_number,
  mm.claim_disposition,
  mm.payee_code,
  mm.network_indicator,
  mm.bill_type,
  mm.internal_provider_number,
  mm.provider_name,
  mm.provider_address_1,
  mm.provider_address_2,
  mm.provider_city,
  mm.provider_state,
  mm.provider_zip_code,
  mm.specialty_code,
  mm.specialty_code_description,
  mm.npi_reimbursement_number,
  mm.npi_rendering_number,
  mm.par_nonpar_code,
  mm.product_description,
  mm.place_of_service_code,
  mm.type_of_service_code,
  mm.cpt,
  mm.cpt_modifier_1,
  mm.cpt_modifier_2,
  mm.revenue_code,
  mm.primary_diagnosis_code_icd9,
  mm.secondary_diagnosis_code_icd9,
  mm.tertiary_diagnosis_code_icd9,
  mm.icd9_surgical_procedure_code_1,
  mm.icd9_surgical_procedure_code_2,
  mm.icd9_surgical_procedure_code_3,
  mm.icd9_surgical_procedure_code_4,
  mm.institutional_diagnosis_1_icd9,
  mm.institutional_diagnosis_2_icd9,
  mm.institutional_diagnosis_3_icd9,
  mm.institutional_diagnosis_4_icd9,
  mm.professional_diagnosis_1_icd9,
  mm.primary_diagnosis_code_icd10,
  mm.secondary_diagnosis_code_icd10,
  mm.tertiary_diagnosis_code_icd10,
  mm.icd10_surgical_procedure_code_1,
  mm.icd10_surgical_procedure_code_2,
  mm.icd10_surgical_procedure_code_3,
  mm.icd10_surgical_procedure_code_4,
  mm.institutional_diagnosis_1_icd10,
  mm.institutional_diagnosis_2_icd10,
  mm.institutional_diagnosis_3_icd10,
  mm.institutional_diagnosis_4_icd10,
  mm.professional_diagnosis_1_icd10,
  mm.primary_present_on_admission,
  mm.secondary_present_on_admission,
  mm.tertiary_present_on_admission,
  mm.discharge_status,
  mm.receipt_date,
  mm.paid_date,
  mm.line_service_from_date,
  mm.line_service_thru_date,
  mm.header_service_from_date,
  mm.header_service_thru_date,
  mm.admission_date,
  mm.discharge_date,
  mm.number_of_submitted_inpatient_days,
  mm.number_of_covered_inpatient_days,
  mm.number_of_services,
  aac.max_supplier_file_log_id,
  aac.max_rec_num,
  aac.total_allowed_amount,
  aac.total_copay_amount,
  aac.total_coinsurance_amount,
  aac.total_deductible_amount,
  aac.total_paid_amount,
  aac.total_its_access_fees,
  aac.total_its_supplemental_fees,
  aac.total_surcharge_amount,
  aac.total_medicare_paid_amount,
  aac.total_non_covered_amount,
  aac.total_cob_amount
from {{ ref('medical_63_agg') }} as aac
inner join {{ source('raw', 's_63_merged_medical') }} as mm
  on mm.rec_num = aac.rec_num
  and mm.supplier_file_log_id = aac.supplier_file_log_id
inner join {{ ref('member_63_stg') }} as mem
  on mem.memb_life_id = mm.memb_life_id_skey
where 1=1 
  and aac.supplier_file_log_id = aac.max_supplier_file_log_id
  and aac.rec_num = aac.max_rec_num
  and mem.supplier_file_log_id = mem.max_supplier_file_log_id
  and mem.rec_num = mem.max_rec_num